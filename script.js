const translations = {
    ru: {
        // ... (СТАРЫЕ ПЕРЕВОДЫ БЕЗ ИЗМЕНЕНИЙ) ...
        title: "Дневник", newTradeTitle: "Новая сделка",
        coin: "Монета", position: "Позиция", date: "Дата", risk: "Риск ($)", profit: "Прибыль ($)", loss: "Убыток ($)", result: "Итог (%)", notes: "Сетап / Заметки",
        addPhoto: "Добавить фото", photoHint: "Макс. 3 фото", saveBtn: "Сохранить сделку", cancelBtn: "Отмена",
        historyTitle: "История", tableDate: "Дата", tablePair: "Пара", tablePos: "Поз.", tableAct: "Действия",
        equityTitle: "Кривая капитала", statTotal: "Всего сделок", statWinrate: "Винрейт", statNet: "Чистая прибыль", statFactor: "Профит фактор",
        navInput: "Ввод", navJournal: "Журнал", navAnalysis: "Анализ", modalTitle: "Просмотр", updateBtn: "Обновить запись",
        toastSaved: "Сделка сохранена!", toastUpdated: "Сделка обновлена!", toastDeleted: "Сделка удалена", confirmDelete: "Удалить запись?",
        achievementsTitle: "Достижения", scrollHint: "Свайп для просмотра",
        achieve1: "Первая кровь", achieve1Desc: "Первая закрытая сделка",
        achieve2: "Снайпер", achieve2Desc: "Винрейт > 60% (мин 5 сделок)",
        achieve3: "Кит", achieve3Desc: "Профит > $1000",
        achieve4: "Стальные яйца", achieve4Desc: "20+ сделок в журнале",
        emptyState: "История чиста. Время открыть первую сделку!", startBtn: "Начать",
        greetMorning: "Доброе утро, Трейдер", greetDay: "Продуктивного дня", greetEvening: "Добрый вечер", greetNight: "Рынок не спит, и ты тоже",
        dropHint: "Нажми или перетащи скриншот сюда",
        calcTitle: "Калькулятор Риска", calcDeposit: "Твой Депозит ($)", calcRiskPercent: "Риск (%)", calcApply: "Применить",
        weekDays: ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"],
        tapHint: "Нажми на день для подробностей",
        dayNet: "Чистый итог", dayTrades: "Сделки дня",
        riskWidgetTitle: "Дневной риск", riskStatusSafe: "БЕЗОПАСНО", riskStatusWarn: "ОСТОРОЖНО", riskStatusDanger: "СТОП ТОРГИ",
        riskSettingsTitle: "Настройка Риска", dailyLossLimit: "Дневной лимит убытка ($)", riskDesc: "Если убыток за день превысит эту сумму, виджет станет красным.",
        tagsTitle: "Теги", tagsHint: "Клик - выбор, Крестик - удаление", tagsAnalysisTitle: "Эффективность Тегов",
        confirmTagDelete: "Удалить тег?",
        dataModalTitle: "Управление данными", dataModalDesc: "Сохрани резервную копию своих данных, чтобы не потерять журнал. Или загрузи файл для восстановления.",
        exportBtn: "Скачать Бэкап (Экспорт)", importBtn: "Загрузить Бэкап (Импорт)", importSuccess: "Данные успешно загружены!", importError: "Ошибка чтения файла!",
        timeAnalysisTitle: "Прибыль по времени",
        
        // НОВЫЕ ПЕРЕВОДЫ ДЛЯ МОНЕТ
        addCoinTitle: "Добавить пару",
        addCoinDesc: "Введи название торговой пары (например, APT/USDT).",
        addBtn: "Добавить"
    },
    en: {
        // ... (СТАРЫЕ ПЕРЕВОДЫ БЕЗ ИЗМЕНЕНИЙ) ...
        title: "Journal", newTradeTitle: "New Trade",
        coin: "Coin", position: "Position", date: "Date", risk: "Risk ($)", profit: "Profit ($)", loss: "Loss ($)", result: "Result (%)", notes: "Setup / Notes",
        addPhoto: "Add Photo", photoHint: "Max 3 photos", saveBtn: "Save Trade", cancelBtn: "Cancel",
        historyTitle: "History", tableDate: "Date", tablePair: "Pair", tablePos: "Pos.", tableAct: "Actions",
        equityTitle: "Equity Curve", statTotal: "Total Trades", statWinrate: "Winrate", statNet: "Net Profit", statFactor: "Profit Factor",
        navInput: "Input", navJournal: "Journal", navAnalysis: "Analysis", modalTitle: "View Image", updateBtn: "Update Trade",
        toastSaved: "Trade Saved!", toastUpdated: "Trade Updated!", toastDeleted: "Trade Deleted", confirmDelete: "Delete record?",
        achievementsTitle: "Achievements", scrollHint: "Swipe to view table",
        achieve1: "First Blood", achieve1Desc: "First trade closed",
        achieve2: "Sniper", achieve2Desc: "Winrate > 60% (min 5 trades)",
        achieve3: "Whale", achieve3Desc: "Profit > $1000",
        achieve4: "Iron Hands", achieve4Desc: "20+ trades logged",
        emptyState: "History is clean. Time to make the first trade!", startBtn: "Start",
        greetMorning: "Good Morning", greetDay: "Good Afternoon", greetEvening: "Good Evening", greetNight: "Market never sleeps",
        dropHint: "Click or drag screenshot here",
        calcTitle: "Risk Calculator", calcDeposit: "Your Balance ($)", calcRiskPercent: "Risk (%)", calcApply: "Apply Risk",
        weekDays: ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"],
        tapHint: "Tap on day to see details",
        dayNet: "Net Result", dayTrades: "Trades of the day",
        riskWidgetTitle: "Daily Risk Guard", riskStatusSafe: "SAFE", riskStatusWarn: "WARNING", riskStatusDanger: "STOP TRADING",
        riskSettingsTitle: "Risk Settings", dailyLossLimit: "Daily Loss Limit ($)", riskDesc: "If daily loss exceeds this amount, widget turns red.",
        tagsTitle: "Tags", tagsHint: "Click to select, X to delete", tagsAnalysisTitle: "Tags Performance",
        confirmTagDelete: "Delete tag?",
        dataModalTitle: "Data Management", dataModalDesc: "Save a backup of your data to keep it safe. Or load a file to restore.",
        exportBtn: "Download Backup (Export)", importBtn: "Upload Backup (Import)", importSuccess: "Data loaded successfully!", importError: "Error reading file!",
        timeAnalysisTitle: "Time Analysis",
        
        // НОВЫЕ ПЕРЕВОДЫ
        addCoinTitle: "Add Pair",
        addCoinDesc: "Enter the trading pair name (e.g. APT/USDT).",
        addBtn: "Add"
    }
};

let trades = JSON.parse(localStorage.getItem("trades")) || [];
let coins = JSON.parse(localStorage.getItem("coins")) || ["BTC/USDT", "ETH/USDT", "SOL/USDT"];
let availableTags = JSON.parse(localStorage.getItem("availableTags")) || ["Trend", "Reversal", "FOMO", "Impulse", "Scalp"];
let selectedTags = [];

let currentLang = localStorage.getItem("lang");
if (!currentLang) {
    currentLang = "ru";
    localStorage.setItem("lang", "ru");
}

let editId = null;
let equityChartInstance = null;
let timeChartInstance = null;
let currentImages = [];
let privacyMode = false;
let userBalance = localStorage.getItem("userBalance") || "";
let calendarDate = new Date();
let dailyLossLimit = localStorage.getItem("dailyLossLimit") || 0; 
let fpInstance = null; // Инстанс Flatpickr

window.onload = function() {
    setLang(currentLang);
    renderCoinSelect();
    renderTagSelector();
    
    // ИНИЦИАЛИЗАЦИЯ FLATPICKR (НОВОЕ)
    fpInstance = flatpickr("#open_date", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        defaultDate: new Date(),
        minuteIncrement: 1,
        disableMobile: "true" // Чтобы на мобильных тоже был красивый календарь, а не нативный
    });

    updateStats();
    updateGreeting();
    setupDragAndDrop();
    document.getElementById("calcBalance").value = userBalance;
    updateCalcDisplay();
    VanillaTilt.init(document.querySelectorAll(".tilt-card"), { max: 15, speed: 400, glare: true, "max-glare": 0.1 });
};

// Функция для установки даты теперь просто сбрасывает Flatpickr
function setNowDateTime() {
    if(fpInstance) fpInstance.setDate(new Date());
}

function openCalculator() { new bootstrap.Modal(document.getElementById('calcModal')).show(); }

function updateCalcDisplay() {
    const bal = parseFloat(document.getElementById("calcBalance").value) || 0;
    const riskP = parseFloat(document.getElementById("calcRiskInput").value);
    document.getElementById("calcRiskDisplay").innerText = riskP + "%";
    const riskAmount = (bal * riskP) / 100;
    document.getElementById("calcResult").innerText = "$" + riskAmount.toFixed(2);
    localStorage.setItem("userBalance", bal);
}

function applyRisk() {
    const bal = parseFloat(document.getElementById("calcBalance").value) || 0;
    const riskP = parseFloat(document.getElementById("calcRiskInput").value);
    const riskAmount = (bal * riskP) / 100;
    document.getElementById("risk").value = riskAmount.toFixed(2);
    calcMetrics();
    bootstrap.Modal.getInstance(document.getElementById('calcModal')).hide();
}

/* --- LOGIC FOR CUSTOM COIN MODAL (NEW) --- */
function openAddCoinModal() {
    document.getElementById("newCoinInput").value = ""; // Clear input
    new bootstrap.Modal(document.getElementById('addCoinModal')).show();
}

// Заменили старую addCustomCoin на эту
function addCustomCoin() {
    openAddCoinModal(); // Теперь просто открывает модал
}

function saveCustomCoin() {
    const input = document.getElementById("newCoinInput");
    const val = input.value.trim().toUpperCase();
    
    if(val) {
        if(!coins.includes(val)) {
            coins.push(val);
            localStorage.setItem("coins", JSON.stringify(coins));
            renderCoinSelect();
            document.getElementById("coin").value = val;
            showToast(currentLang === 'ru' ? "Монета добавлена!" : "Coin added!");
        } else {
            showToast(currentLang === 'ru' ? "Такая монета уже есть" : "Coin already exists");
            document.getElementById("coin").value = val;
        }
        bootstrap.Modal.getInstance(document.getElementById('addCoinModal')).hide();
    }
}

// Обработка Enter в модальном окне монеты
document.getElementById("newCoinInput").addEventListener("keyup", function(event) {
    if (event.key === "Enter") {
        saveCustomCoin();
    }
});

/* --- AUTO CALCULATIONS --- */
function calcMetrics() {
    calcFormRR();
    calcResultPercentage();
}

function calcResultPercentage() {
    const balance = parseFloat(localStorage.getItem("userBalance"));
    if (!balance || balance <= 0) return;
    const profit = parseFloat(document.getElementById("profit").value) || 0;
    const loss = parseFloat(document.getElementById("loss").value) || 0;
    const resultInput = document.getElementById("result");
    let percent = 0;
    if (profit > 0) percent = (profit / balance) * 100;
    else if (loss > 0) percent = -(loss / balance) * 100;
    if (profit > 0 || loss > 0) resultInput.value = percent.toFixed(2);
    else resultInput.value = "";
}

function calcFormRR() {
    const risk = parseFloat(document.getElementById("risk").value);
    const profit = parseFloat(document.getElementById("profit").value);
    const badge = document.getElementById("rrPreviewBadge");
    if (risk > 0 && profit > 0) {
        const ratio = (profit / risk).toFixed(1);
        badge.innerText = `R:R 1:${ratio}`;
        badge.style.opacity = "1";
        badge.className = "badge font-mono transition-icon"; 
        if(ratio >= 3) badge.classList.add("bg-success");
        else if(ratio >= 2) badge.classList.add("bg-primary");
        else badge.classList.add("bg-secondary");
    } else {
        badge.style.opacity = "0";
    }
}

function generateShareCard(tradeId) {
    const t = trades.find(tr => tr.id === tradeId);
    if (!t) return;
    const canvas = document.getElementById('shareCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1080; canvas.height = 1080;
    const gradient = ctx.createLinearGradient(0, 0, 0, 1080);
    gradient.addColorStop(0, '#161b22'); gradient.addColorStop(1, '#0f1115');
    ctx.fillStyle = gradient; ctx.fillRect(0, 0, 1080, 1080);
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)'; ctx.lineWidth = 2;
    for(let i=0; i<1080; i+=60) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(1080, i); ctx.stroke(); ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, 1080); ctx.stroke(); }
    ctx.fillStyle = '#ffffff'; ctx.font = 'bold 120px Inter'; ctx.textAlign = 'center'; ctx.fillText(t.coin, 540, 400);
    const isWin = t.result > 0; const pnl = isWin ? t.profit : -t.loss; const sign = pnl > 0 ? '+' : '';
    ctx.fillStyle = isWin ? '#238636' : '#da3633'; ctx.font = 'bold 180px Roboto Mono';
    ctx.shadowColor = isWin ? 'rgba(35, 134, 54, 0.5)' : 'rgba(218, 54, 51, 0.5)'; ctx.shadowBlur = 40;
    ctx.fillText(`${sign}${pnl}$`, 540, 600); ctx.shadowBlur = 0;
    ctx.fillStyle = '#8b949e'; ctx.font = '60px Inter'; ctx.fillText(`ROI: ${t.result}%`, 540, 700);
    ctx.fillStyle = '#3b82f6'; ctx.font = 'bold 50px Inter'; ctx.fillText('СМОТРИТЕЛЬ РЫНКА', 540, 950);
    ctx.fillStyle = '#ffffff'; ctx.font = '30px Inter'; 
    // Format date for share card
    const dateDisplay = t.date.includes('T') || t.date.includes(' ') ? t.date.substring(0, 10) : t.date;
    ctx.fillText(dateDisplay, 540, 1000);
    const link = document.createElement('a'); link.download = `trade_${t.coin}_${dateDisplay}.png`; link.href = canvas.toDataURL(); link.click();
}

function togglePrivacy() {
    privacyMode = !privacyMode;
    const btn = document.getElementById("privacyBtn"); const icon = btn.querySelector("i");
    if (privacyMode) { document.body.classList.add("privacy-active"); icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); btn.classList.add("active"); showToast(currentLang === 'ru' ? "Режим инкогнито вкл." : "Privacy mode ON"); } 
    else { document.body.classList.remove("privacy-active"); icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); btn.classList.remove("active"); }
    updateStats(); renderTable(); renderCalendar();
}

function setupDragAndDrop() {
    const dropZone = document.getElementById("dropZone"); const input = document.getElementById("imageInput");
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false); });
    ['dragenter', 'dragover'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false); });
    ['dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false); });
    dropZone.addEventListener('drop', e => { const files = e.dataTransfer.files; input.files = files; handleImageSelect({ target: { files: files } }); }, false);
}

function updateGreeting() {
    const hour = new Date().getHours(); const t = translations[currentLang];
    let greet = t.greetDay;
    if (hour >= 5 && hour < 12) greet = t.greetMorning; else if (hour >= 18 && hour < 23) greet = t.greetEvening; else if (hour >= 23 || hour < 5) greet = t.greetNight;
    document.getElementById("greeting").innerText = greet + " | Смотритель Рынка";
}
function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#3b82f6', '#8b5cf6', '#238636'] }); }
function setLang(lang) {
    currentLang = lang; localStorage.setItem("lang", lang);
    document.querySelectorAll('[data-translate]').forEach(el => { const key = el.getAttribute('data-translate'); if(translations[lang][key]) el.innerText = translations[lang][key]; });
    document.getElementById("setup").placeholder = lang === 'ru' ? "Почему вошел?" : "Why enter?"; document.getElementById("result").placeholder = "-1.5 / 3.2"; document.getElementById("appTitle").innerText = translations[lang].title;
    const submitBtnText = editId ? translations[lang].updateBtn : translations[lang].saveBtn; document.querySelector("#submitBtn span").innerText = submitBtnText;
    updateStats(); renderTable(); updateGreeting();
}
function handleImageSelect(event) {
    const files = event.target.files; if (!files.length) return;
    if (currentImages.length + files.length > 3) { alert(currentLang === 'ru' ? "Максимум 3 фото!" : "Max 3 photos!"); return; }
    Array.from(files).forEach(file => { const reader = new FileReader(); reader.onload = function(e) { compressImage(e.target.result, 800, 0.7).then(compressedSrc => { currentImages.push(compressedSrc); renderImagePreviews(); }); }; reader.readAsDataURL(file); });
}
function compressImage(src, maxWidth, quality) { return new Promise((resolve) => { const img = new Image(); img.src = src; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); }; }); }
function renderImagePreviews() { const container = document.getElementById("imagePreviewContainer"); container.innerHTML = ""; currentImages.forEach((src, index) => { container.innerHTML += `<div class="img-thumbnail-wrapper"><img src="${src}" onclick="viewFullImage('${src}')"><button class="btn-remove-img" onclick="removeImage(${index})">×</button></div>`; }); }
function removeImage(index) { currentImages.splice(index, 1); renderImagePreviews(); }
function viewFullImage(src) { document.getElementById("modalImageFull").src = src; new bootstrap.Modal(document.getElementById('imageModal')).show(); }

function showSection(sectionId, element) {
    document.getElementById('mainSection').style.display = 'none'; document.getElementById('viewSection').style.display = 'none'; document.getElementById('statsSection').style.display = 'none';
    if(sectionId === 'main') document.getElementById('mainSection').style.display = 'block'; if(sectionId === 'view') { document.getElementById('viewSection').style.display = 'block'; renderTable(); } if(sectionId === 'stats') { document.getElementById('statsSection').style.display = 'block'; updateStats(); }
    document.querySelectorAll('.nav-link-custom').forEach(el => el.classList.remove('active')); if(element) element.classList.add('active');
}
function renderCoinSelect() { const select = document.getElementById("coin"); select.innerHTML = ""; coins.forEach(c => { let opt = document.createElement("option"); opt.value = c; opt.text = c; select.appendChild(opt); }); }
// addCustomCoin перемещен в начало, используем openAddCoinModal

/* --- TAGS LOGIC --- */
function renderTagSelector() {
    const container = document.getElementById("tagSelectionContainer");
    container.innerHTML = "";
    availableTags.forEach(tag => {
        const isActive = selectedTags.includes(tag);
        container.innerHTML += `
        <div class="tag-chip ${isActive ? 'active' : ''}">
            <span onclick="toggleTag('${tag}')">${tag}</span>
            <span class="tag-delete" onclick="deleteTag('${tag}')">✕</span>
        </div>`;
    });
}
function toggleTag(tag) {
    if (selectedTags.includes(tag)) { selectedTags = selectedTags.filter(t => t !== tag); } 
    else { selectedTags.push(tag); }
    renderTagSelector();
}
function deleteTag(tag) {
    if(confirm(`${translations[currentLang].confirmTagDelete} "${tag}"`)) {
        availableTags = availableTags.filter(t => t !== tag);
        selectedTags = selectedTags.filter(t => t !== tag);
        localStorage.setItem("availableTags", JSON.stringify(availableTags));
        renderTagSelector();
    }
}
function addNewTag() {
    const input = document.getElementById("newTagInput");
    const val = input.value.trim();
    if(val && !availableTags.includes(val)) {
        availableTags.push(val);
        selectedTags.push(val);
        localStorage.setItem("availableTags", JSON.stringify(availableTags));
        input.value = "";
        renderTagSelector();
    }
}

function saveTrade(e) {
    e.preventDefault();
    const trade = { 
        id: editId || Date.now(), 
        coin: document.getElementById("coin").value, 
        position: document.getElementById("position").value, 
        date: document.getElementById("open_date").value, // Flatpickr puts string here
        risk: parseFloat(document.getElementById("risk").value) || 0, 
        profit: parseFloat(document.getElementById("profit").value) || 0, 
        loss: parseFloat(document.getElementById("loss").value) || 0, 
        result: parseFloat(document.getElementById("result").value) || 0, 
        setup: document.getElementById("setup").value, 
        images: currentImages,
        tags: selectedTags 
    };
    if (trade.result > 0 && !editId) triggerConfetti();
    if(editId) { trades[trades.findIndex(t => t.id === editId)] = trade; showToast(translations[currentLang].toastUpdated); editId = null; document.querySelector("#submitBtn span").innerText = translations[currentLang].saveBtn; document.getElementById("cancelBtn").style.display = 'none'; } 
    else { trades.push(trade); showToast(translations[currentLang].toastSaved); }
    localStorage.setItem("trades", JSON.stringify(trades)); 
    e.target.reset(); 
    setNowDateTime(); 
    document.getElementById("rrPreviewBadge").style.opacity = "0"; 
    currentImages = []; 
    selectedTags = []; 
    renderImagePreviews();
    renderTagSelector();
}
function deleteTrade(id) { if(confirm(translations[currentLang].confirmDelete)) { trades = trades.filter(t => t.id !== id); localStorage.setItem("trades", JSON.stringify(trades)); renderTable(); updateStats(); showToast(translations[currentLang].toastDeleted); } }
function editTrade(id) {
    const t = trades.find(t => t.id === id); if(!t) return;
    editId = id; document.getElementById("coin").value = t.coin; document.getElementById("position").value = t.position; 
    
    // Set date for Flatpickr
    if(fpInstance) fpInstance.setDate(t.date);
    else document.getElementById("open_date").value = t.date;

    document.getElementById("risk").value = t.risk; document.getElementById("profit").value = t.profit; document.getElementById("loss").value = t.loss; document.getElementById("result").value = t.result; document.getElementById("setup").value = t.setup; 
    currentImages = t.images || []; 
    selectedTags = t.tags || []; 
    renderImagePreviews();
    renderTagSelector();
    calcMetrics(); 
    document.querySelector("#submitBtn span").innerText = translations[currentLang].updateBtn; document.getElementById("cancelBtn").style.display = 'block'; showSection('main', document.querySelector('.nav-link-custom:nth-child(1)'));
}
function cancelEdit() { 
    editId = null; 
    document.getElementById("tradeForm").reset(); 
    setNowDateTime();
    document.getElementById("rrPreviewBadge").style.opacity = "0";
    currentImages = []; 
    selectedTags = []; 
    renderImagePreviews(); 
    renderTagSelector();
    document.querySelector("#submitBtn span").innerText = translations[currentLang].saveBtn; document.getElementById("cancelBtn").style.display = 'none'; 
}

function renderTable() {
    const tbody = document.getElementById("tradesBody"); tbody.innerHTML = "";
    if (trades.length === 0) { tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5"><i class="fas fa-rocket fa-3x text-muted mb-3 opacity-25"></i><h5 class="text-muted fw-normal">${translations[currentLang].emptyState}</h5><button class="btn btn-outline-primary btn-sm mt-2" onclick="showSection('main', document.querySelector('.nav-link-custom:nth-child(1)'))">${translations[currentLang].startBtn}</button></td></tr>`; return; }
    [...trades].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
        const isWin = t.result > 0; 
        const pnl = isWin ? t.profit : -t.loss; 
        const pnlClass = isWin ? 'text-profit' : (t.result < 0 ? 'text-loss' : ''); 
        const imageIcon = (t.images && t.images.length > 0) ? `<i class="fas fa-camera text-muted ms-1"></i>` : ''; 
        const blurClass = "privacy-blur"; 
        
        let tagsHtml = '';
        if(t.tags && t.tags.length > 0) {
            tagsHtml = '<div class="mt-1">';
            t.tags.forEach(tag => { tagsHtml += `<span class="tag-badge-table">${tag}</span>`; });
            tagsHtml += '</div>';
        }

        let rrHtml = '';
        if (t.risk > 0) {
            const rMultiple = isWin 
                ? (t.profit / t.risk).toFixed(1) 
                : -(t.loss / t.risk).toFixed(1);
            const rrClass = rMultiple >= 2 ? 'good' : (rMultiple < 1 && rMultiple > 0 ? 'bad' : '');
            rrHtml = `<small class="rr-badge ${rrClass} font-mono mt-1">${rMultiple}R</small>`;
        }
        
        const dateObj = new Date(t.date);
        const dateDisplay = isNaN(dateObj.getTime()) ? t.date : 
            `${dateObj.toLocaleDateString()} <br><small class='text-muted'>${dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</small>`;

        tbody.innerHTML += `
        <tr>
            <td class="text-muted small" style="line-height:1.2">${dateDisplay}</td>
            <td><strong class="text-white">${t.coin}</strong>${imageIcon}${tagsHtml}</td>
            <td><span class="badge ${t.position === 'Long' ? 'bg-success bg-opacity-10 text-success' : 'bg-danger bg-opacity-10 text-danger'}">${t.position}</span></td>
            <td class="${pnlClass} font-mono ${blurClass}">
                <div class="d-flex flex-column align-items-end justify-content-center">
                    <span>${pnl > 0 ? '+' : ''}${pnl}$</span>
                    ${rrHtml}
                </div>
            </td>
            <td class="text-end ${pnlClass} font-mono">${t.result}%</td>
            <td class="text-center">
                <button class="btn btn-sm btn-link text-muted" onclick="generateShareCard(${t.id})" title="Share"><i class="fas fa-share-nodes"></i></button>
                <button class="btn btn-sm btn-link text-muted" onclick="editTrade(${t.id})"><i class="fas fa-pen"></i></button>
                <button class="btn btn-sm btn-link text-muted" onclick="deleteTrade(${t.id})"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    });
}
function updateStats() {
    const totalTrades = trades.length; const wins = trades.filter(t => t.result > 0).length; const winRate = totalTrades ? ((wins / totalTrades) * 100).toFixed(1) : 0;
    const totalProfit = trades.reduce((acc, t) => acc + (t.profit || 0), 0); const totalLoss = trades.reduce((acc, t) => acc + (t.loss || 0), 0); const netProfit = totalProfit - totalLoss; const profitFactor = totalLoss ? (totalProfit / totalLoss).toFixed(2) : (totalTrades > 0 ? "∞" : "0");
    document.getElementById("totalTrades").innerText = totalTrades; document.getElementById("winRate").innerText = winRate + "%";
    const netEl = document.getElementById("totalNetProfit"); netEl.innerText = netProfit.toFixed(2) + "$"; netEl.className = "stat-value font-mono privacy-target privacy-blur " + (netProfit >= 0 ? "text-success" : "text-danger");
    document.getElementById("profitFactor").innerText = profitFactor; 
    renderChart(); renderAchievements(totalTrades, netProfit, winRate); renderCalendar();
    renderTagsAnalytics();
    renderTimeChart(); // RENDER TIME CHART
    renderRiskWidget();
}
function renderTagsAnalytics() {
    const container = document.getElementById("tagsStatsContainer");
    container.innerHTML = "";
    
    const stats = {};
    trades.forEach(t => {
        if(t.tags && t.tags.length > 0) {
            t.tags.forEach(tag => {
                if(!stats[tag]) stats[tag] = { pnl: 0, wins: 0, count: 0 };
                stats[tag].pnl += (t.result > 0 ? t.profit : -t.loss);
                if(t.result > 0) stats[tag].wins++;
                stats[tag].count++;
            });
        }
    });
    const entries = Object.entries(stats);
    if(entries.length === 0) { container.innerHTML = `<div class="text-center text-muted small py-2">Нет данных по тегам</div>`; return; }
    entries.sort((a, b) => b[1].pnl - a[1].pnl);
    entries.forEach(([tag, data]) => {
        const isPos = data.pnl >= 0;
        const winRate = ((data.wins / data.count) * 100).toFixed(0);
        container.innerHTML += `
        <div class="tag-stat-card">
            <div><strong class="text-white">${tag}</strong><div class="small text-muted">${data.count} trades | ${winRate}% WR</div></div>
            <div class="font-mono ${isPos ? 'text-success' : 'text-danger'} privacy-blur" style="font-weight:700">${isPos?'+':''}${data.pnl.toFixed(2)}$</div>
        </div>`;
    });
}

// --- TIME ANALYSIS CHART ---
function renderTimeChart() {
    const ctx = document.getElementById('timeChart').getContext('2d');
    
    // Buckets: 0-4, 4-8, 8-12, 12-16, 16-20, 20-24
    const buckets = {
        '00-04': 0, '04-08': 0, '08-12': 0, '12-16': 0, '16-20': 0, '20-00': 0
    };

    trades.forEach(t => {
        let hour = 0;
        if(t.date.includes(' ') || t.date.includes('T')) {
            hour = new Date(t.date).getHours();
        } else {
            return; 
        }
        const pnl = t.result > 0 ? t.profit : -t.loss;

        if (hour < 4) buckets['00-04'] += pnl;
        else if (hour < 8) buckets['04-08'] += pnl;
        else if (hour < 12) buckets['08-12'] += pnl;
        else if (hour < 16) buckets['12-16'] += pnl;
        else if (hour < 20) buckets['16-20'] += pnl;
        else buckets['20-00'] += pnl;
    });

    const labels = Object.keys(buckets);
    const data = Object.values(buckets);
    const backgroundColors = data.map(val => val >= 0 ? '#238636' : '#da3633'); 

    if (timeChartInstance) timeChartInstance.destroy();

    timeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'PnL ($)',
                data: data,
                backgroundColor: backgroundColors,
                borderRadius: 4,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { display: false }, ticks: { color: '#9ca3af', font: {size: 10} } },
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } }
            }
        }
    });
}

function renderAchievements(total, profit, winRate) {
    const grid = document.getElementById('achievementsGrid'); grid.innerHTML = ""; const t = translations[currentLang];
    const badges = [ { id: 1, name: t.achieve1, desc: t.achieve1Desc, icon: "fa-baby", unlocked: total >= 1 }, { id: 2, name: t.achieve2, desc: t.achieve2Desc, icon: "fa-crosshairs", unlocked: winRate >= 60 && total >= 5 }, { id: 3, name: t.achieve3, desc: t.achieve3Desc, icon: "fa-crown", unlocked: profit >= 1000 }, { id: 4, name: t.achieve4, desc: t.achieve4Desc, icon: "fa-hand-fist", unlocked: total >= 20 } ];
    badges.forEach(b => { grid.innerHTML += `<div class="col-6 col-md-3"><div class="achievement-card ${b.unlocked ? 'unlocked' : ''}" onclick="showAchieveDetail('${b.name}', '${b.desc}', '${b.icon}', ${b.unlocked})"><i class="fas ${b.icon} achievement-icon"></i><h6 class="mb-0 fw-bold">${b.name}</h6></div></div>`; });
}
function showAchieveDetail(name, desc, icon, unlocked) {
    document.getElementById("achieveModalTitle").innerText = name; document.getElementById("achieveModalDesc").innerText = desc;
    const iconEl = document.getElementById("achieveModalIcon"); iconEl.className = `fas ${icon} fa-3x mb-3 ${unlocked ? 'text-warning' : 'text-muted'}`;
    new bootstrap.Modal(document.getElementById('achievementModal')).show(); if(unlocked) triggerConfetti();
}
function renderChart() {
    const ctx = document.getElementById('equityChart').getContext('2d'); const sortedHistory = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date)); let balance = 0, labels = [], dataPoints = []; sortedHistory.forEach((t, index) => { balance += (t.result > 0) ? t.profit : -t.loss; labels.push(`${index + 1}`); dataPoints.push(balance); });
    if (equityChartInstance) equityChartInstance.destroy(); let gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
    equityChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Equity ($)', data: dataPoints, borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, pointRadius: 2, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: 'rgba(255,255,255,0.05)' } } } } });
}
function showToast(msg) { Toastify({ text: msg, duration: 3000, gravity: "bottom", position: "right", style: { background: "var(--primary-accent)" } }).showToast(); }

/* --- CALENDAR LOGIC --- */
function changeMonth(step) { calendarDate.setMonth(calendarDate.getMonth() + step); renderCalendar(); }
function renderCalendarHeader() { const header = document.getElementById("calendarHeader"); const days = translations[currentLang].weekDays; header.innerHTML = ""; days.forEach(day => { header.innerHTML += `<div>${day}</div>`; }); }
function renderCalendar() {
    renderCalendarHeader(); const year = calendarDate.getFullYear(); const month = calendarDate.getMonth();
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const monthNamesRu = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
    document.getElementById("calendarMonthLabel").innerText = `${currentLang === 'ru' ? monthNamesRu[month] : monthNames[month]} ${year}`;
    const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
    const grid = document.getElementById("calendarGrid"); grid.innerHTML = ""; let startOffset = firstDay === 0 ? 6 : firstDay - 1;
    for(let i=0; i<startOffset; i++) { grid.innerHTML += `<div class="calendar-day empty"></div>`; }
    for(let day=1; day<=daysInMonth; day++) {
        const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const dayTrades = trades.filter(t => t.date.startsWith(dateStr)); 
        let dayPnl = 0; dayTrades.forEach(t => { dayPnl += (t.result > 0 ? t.profit : -t.loss); });
        let content = `<span class="day-number">${day}</span>`; let classes = "calendar-day";
        if (dayTrades.length > 0) { if (dayPnl > 0) classes += " win"; if (dayPnl < 0) classes += " loss"; const pnlFormatted = (dayPnl > 0 ? "+" : "") + dayPnl.toFixed(0) + "$"; const countText = dayTrades.length + (currentLang==='ru' ? " сд." : " tr."); content += `<div class="day-profit font-mono ${dayPnl >= 0 ? 'text-white' : 'text-white'} privacy-blur">${pnlFormatted}</div><div class="day-count">${countText}</div>`; }
        grid.innerHTML += `<div class="${classes}" onclick="openDayDetails('${dateStr}')">${content}</div>`;
    }
}
function openDayDetails(dateStr) {
    const dayTrades = trades.filter(t => t.date.startsWith(dateStr)); document.getElementById("dayDetailsDate").innerText = dateStr;
    let net = 0; dayTrades.forEach(t => net += (t.result > 0 ? t.profit : -t.loss));
    const netEl = document.getElementById("dayDetailsNet"); netEl.innerText = (net > 0 ? "+" : "") + net.toFixed(2) + "$"; netEl.className = "font-mono mb-0 privacy-blur " + (net >= 0 ? "text-success" : "text-danger");
    document.getElementById("dayDetailsCount").innerText = dayTrades.length + (currentLang === 'ru' ? " Сделок" : " Trades");
    const list = document.getElementById("dayTradesList"); list.innerHTML = "";
    if(dayTrades.length === 0) { list.innerHTML = `<div class="text-center text-muted py-3 small">${currentLang==='ru' ? 'В этот день не было сделок' : 'No trades on this day'}</div>`; } 
    else { dayTrades.forEach(t => { const isWin = t.result > 0; const pnl = isWin ? t.profit : -t.loss; list.innerHTML += `<div class="trade-mini-card"><div class="d-flex align-items-center gap-2"><span class="badge ${t.position === 'Long' ? 'bg-success' : 'bg-danger'} bg-opacity-25 text-white" style="font-size:0.6rem">${t.position}</span><strong class="text-white">${t.coin}</strong></div><div class="text-end"><div class="font-mono ${isWin ? 'text-success' : 'text-danger'} privacy-blur">${isWin?'+':''}${pnl}$</div><small>${t.result}%</small></div></div>`; }); }
    new bootstrap.Modal(document.getElementById('dayDetailsModal')).show();
}

/* --- RISK WIDGET LOGIC --- */
function openRiskSettings() {
    document.getElementById("dailyLossInput").value = dailyLossLimit;
    new bootstrap.Modal(document.getElementById('riskLimitModal')).show();
}

function saveRiskLimit() {
    const val = parseFloat(document.getElementById("dailyLossInput").value);
    dailyLossLimit = val >= 0 ? val : 0;
    localStorage.setItem("dailyLossLimit", dailyLossLimit);
    bootstrap.Modal.getInstance(document.getElementById('riskLimitModal')).hide();
    renderRiskWidget();
    showToast(currentLang === 'ru' ? "Лимит риска сохранен!" : "Risk limit saved!");
}

function renderRiskWidget() {
    const t = translations[currentLang];
    // Compare YYYY-MM-DD
    const todayStr = new Date().toISOString().split('T')[0];
    const todayTrades = trades.filter(tr => tr.date.startsWith(todayStr));
    let todayPnl = 0;
    todayTrades.forEach(tr => todayPnl += (tr.result > 0 ? tr.profit : -tr.loss));

    const currentEl = document.getElementById("riskWidgetCurrent");
    const limitEl = document.getElementById("riskWidgetLimit");
    const bar = document.getElementById("riskProgressBar");
    const status = document.getElementById("riskWidgetStatus");
    const card = document.getElementById("riskWidgetCard");

    currentEl.innerText = (todayPnl > 0 ? "+" : "") + todayPnl.toFixed(2) + "$";
    limitEl.innerText = `Limit: ${dailyLossLimit}$`;
    
    // Сброс классов
    card.classList.remove("pulse-warning", "pulse-orange", "pulse-critical");
    bar.className = "progress-bar";
    status.className = "badge";

    if (!dailyLossLimit || dailyLossLimit == 0) {
        bar.style.width = "0%"; bar.style.backgroundColor = "var(--text-muted)";
        status.innerText = "NO LIMIT"; status.classList.add("bg-secondary");
        return;
    }

    if (todayPnl >= 0) {
        bar.style.width = "0%"; status.innerText = t.riskStatusSafe; status.classList.add("bg-success");
        currentEl.className = "mb-0 font-mono privacy-blur text-success";
    } else {
        const loss = Math.abs(todayPnl);
        const percent = (loss / dailyLossLimit) * 100;
        
        currentEl.className = "mb-0 font-mono privacy-blur text-danger";
        bar.style.width = Math.min(percent, 100) + "%";

        if (percent < 50) {
            bar.style.backgroundColor = "var(--success)";
            status.innerText = t.riskStatusSafe;
            status.classList.add("bg-success");
        } else if (percent < 75) {
            bar.style.backgroundColor = "var(--warning)";
            status.innerText = t.riskStatusWarn;
            status.classList.add("bg-warning", "text-dark");
            card.classList.add("pulse-warning");
        } else if (percent < 100) {
            bar.style.backgroundColor = "var(--orange)";
            status.innerText = t.riskStatusWarn; 
            status.classList.add("bg-warning", "text-dark");
            card.classList.add("pulse-orange");
        } else {
            bar.style.backgroundColor = "var(--danger)";
            status.innerText = t.riskStatusDanger;
            status.classList.add("bg-danger");
            card.classList.add("pulse-critical");
        }
    }
}

/* --- BACKUP LOGIC --- */
function openDataModal() {
    new bootstrap.Modal(document.getElementById('dataModal')).show();
}

function exportData() {
    const data = {
        trades: trades,
        coins: coins,
        userBalance: userBalance,
        dailyLossLimit: dailyLossLimit,
        availableTags: availableTags
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `trading_journal_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showToast("Бэкап скачан!");
}

function importDataTrigger() {
    document.getElementById("importFileInput").click();
}

function importDataFile(event) {
    const file = event.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(data.trades) {
                localStorage.setItem("trades", JSON.stringify(data.trades));
                localStorage.setItem("coins", JSON.stringify(data.coins || coins));
                localStorage.setItem("userBalance", data.userBalance || "");
                localStorage.setItem("dailyLossLimit", data.dailyLossLimit || 0);
                localStorage.setItem("availableTags", JSON.stringify(data.availableTags || availableTags));
                
                alert(translations[currentLang].importSuccess);
                location.reload();
            } else {
                alert("Invalid backup file");
            }
        } catch(err) {
            console.error(err);
            alert(translations[currentLang].importError);
        }
    };
    reader.readAsText(file);
}